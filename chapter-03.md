# OpenVPN

В этой главе мы обсудим природу OpenVPN. Мы начнем с его функций и истории выпуска, а затем с его основных сетевых концепций и первого краткого взгляда на конфигурацию. В конце главы, OpenVPN - это по сравнению с IPSec, квази-стандарт в технологии VPN.

В этой главе будет рассмотрено следующее:

* Преимущества OpenVPN
* История OpenVPN
* Сетевое взаимодействие с OpenVPN
* OpenVPN и брандмауэры
* Настройка OpenVPN
* OpenVPN по сравнению с IPSec
* Источники документации

## Преимущества OpenVPN

С появлением OpenVPN на сцену вышло новое поколение VPN. В то время как другие решения VPN часто используют собственные или нестандартные механизмы, OpenVPN имеет модульную концепцию, как для базовой безопасности, так и для сетей. OpenVPN использует безопасные, стабильные и хваленые механизмы SSL/TLS и объединяет их в своем собственном уровне надежности. Он не страдает от сложности, которая характеризует другие реализации VPN, такие как лидер рынка IPsec. В то же время, предлагает возможности, которые выходят за рамки любой другой реализации VPN.

* **VPN уровня 2 и уровня 3**: OpenVPN предлагает два основных режима, которые работают либо как VPN уровня 2, либо как VPN уровня 3. Таким образом, туннели OpenVPN на уровне 2 могут также транспортировать кадры Ethernet, пакеты IPX и пакеты просмотра сети Windows (NETBIOS), все из которых являются проблемами в большинстве других решений VPN.

* **Защита полевых работников с помощью внутреннего брандмауэра**: полевой работник, подключенный к центральному филиалу своей компании с помощью VPN-туннеля, может изменить настройки сети на своем ноутбуке таким образом, чтобы весь сетевой трафик передавался через туннель. Как только OpenVPN установит туннель, центральный брандмауэр в центральном филиале компании сможет защитить ноутбук, даже если это не локальная машина. Только один сетевой порт должен быть открыт для локальной (клиентской) сети полевым работником. Сотрудник защищен центральным брандмауэром всякий раз, когда он подключен к VPN. Более того, администратор Центрального VPN-сервера может заставить клиента использовать центральный брандмауэр, навязав клиентам параметры конфигурации.

* **OpenVPN-соединения могут быть туннелированы почти через каждый брандмауэр и прокси**: если у вас есть доступ в Интернет и вы можете получить доступ к веб-сайтам HTTPS, то туннели OpenVPN должны работать. Установки, где туннели OpenVPN запрещены, очень редки. OpenVPN имеет полную поддержку прокси, включая аутентификацию.

* **Режим сервера и клиента, поддержка UDP и TCP**: OpenVPN может быть настроен для работы в качестве службы TCP или UDP и в качестве сервера или клиента. Как сервер, OpenVPN просто ждет, пока клиент запросит соединение, в то время как клиент устанавливает соединение в соответствии со своей конфигурацией. Сервер в Интернете может быть полностью отключен от любой другой машины, кроме тех, что находятся в его виртуальной частной сети, что значительно повышает уровень безопасности таких систем.

* **Только один порт в брандмауэре должен быть открыт, чтобы разрешить входящие соединения**: начиная с **OpenVPN 2.0**, специальный режим сервера позволяет несколько входящих соединений на одном TCP или UDP-порту, при этом все еще используя различные конфигурации для каждого отдельного соединения.

* **Никаких проблем с NAT**: как OpenVPN-сервер , так и клиенты могут находиться в сети, используя только частные IP-адреса. Каждый брандмауэр можно использовать для отправки туннельного трафика на другую конечную точку туннеля.

* **Виртуальные интерфейсы позволяют гибко использовать очень специфичные сети и почти все мыслимые правила брандмауэра**: все ограничения, механизмы, такие как переадресация, и концепции, такие как **NAT (преобразование сетевых адресов)** или искажение пакетов (изменение метаданных сетевых дейтаграмм, как это делают некоторые брандмауэры), могут использоваться с туннелями OpenVPN и внутри них. Возможен любой IP-протокол. Да, вы можете туннелировать VPN, как IPsec, внутри туннеля OpenVPN.

* **Высокая гибкость с широкими возможностями сценариев**: OpenVPN предлагает множество точек во время настройки соединения для запуска отдельных сценариев. Эти сценарии могут использоваться для самых разных целей - от аутентификации до отработки отказа и т.д.

* **Прозрачная, высокопроизводительная поддержка динамических IP-адресов**: при использовании OpenVPN больше нет необходимости использовать дорогостоящие статические IP-адреса по обе стороны туннеля. Обе конечные точки туннеля могут иметь дешевый DSL-доступ с динамическим IP-адресом. Пользователи редко заметят изменение IP-адреса с обеих сторон, сеансы Windows Terminal Server и Secure Shell (SSH) будут висеть всего несколько секунд, но они не прекратятся и продолжат запрошенное действие после короткой паузы. Весь трафик может быть сжат через библиотеку LZO, и OpenVPN непрерывно проверяет, было ли сжатие успешным. Так называемое адаптивное сжатие просто "стирает" несжатые данные, чтобы избежать ненужных накладных расходов.
* **Простая установка на любую платформу**: как установка, так и использование невероятно просты. Особенно, если вы пытались настроить IPsec-соединения с различными реализациями, вы найдете OpenVPN привлекательным.
* **Модульное проектирование**: модульное проектирование с высокой степенью простоты как в безопасности, так и в сети является выдающимся. Ни одно другое решение VPN не может предложить такие же возможности на этом уровне безопасности.
* **Поддержка мобильных и встроенных устройств**: поддерживается все больше и больше мобильных устройств. Пакеты для Windows Mobile и платформы Maemo от Nokia, а также встроенные операционные системы, такие как OpenWrt/FreeWrt, были предоставлены недавно, и есть много других в разработке.
* **Очень активное сообщество**: OpenVPN за последние несколько лет приобрел огромное количество поклонников. Существуют установки с большим объемом пользователей с высокой доступностью.

## История OpenVPN

По данным интервью на http://linuxsecurity.com опубликованном в 2003 году, Джеймс Йонан путешествовал по Центральной Азии в дни, предшествовавшие 11 сентября 2001 года, и подключался к своему офису через азиатских или российских интернет-провайдеров.

Тот факт, что эти соединения были установлены через серверы в странах с очень сомнительной безопасностью, заставлял его все больше и больше осознавать и беспокоиться о проблемах безопасности. Его исследование показало, что существует два основных потока в технологии VPN, один из которых способствует безопасности, а другой - удобству использования. Ни одно из решений, доступных в то время, не предлагало идеального сочетания обеих целей. IPsec и все его реализации были трудны в настройке, но обеспечивали приемлемую безопасность. Однако его сложная структура делала его уязвимым к атакам, ошибкам и недостаткам безопасности. Поэтому сетевой подход, который Йонан нашел в некоторых решениях usability camp, казалось, имел для него больше смысла, что привело его к модульной сетевой модели с использованием виртуальных сетевых устройств TUN/TAP, которые предоставляются ядром Linux.

> После некоторого изучения области VPN с открытым исходным кодом я пришел к выводу, что лагерь "usability first" имел правильные идеи о сетевом и межсетевом туннелировании, а лагеря SSH, SSL/TLS и IPSec имели соответствующий уровень серьезности по отношению к глубоким криптографическим проблемам. Это было основной концептуальной отправной точкой для моей работы над OpenVPN.

Джеймс Йонан в a LinuxSecurity.com интервью от 10 ноября 2003 года. (http://www.linuxsecurity.com/content/view/117363/49/)

Выбор устройств TUN/TAP в качестве сетевой модели сразу же предложил гибкость, которую не могли предложить другие решения VPN. В то время как другие решения VPN на основе SSL/TLS нуждались в браузере для установления соединений, OpenVPN готовил бы почти реальные (но все же виртуальные) сетевые устройства, на которых можно было бы выполнять почти все сетевые действия.

Йонан тогда выбрал имя OpenVPN в отношении библиотек и программ проекта OpenSSL и из-за четкого сообщения, что это открытое исходное и свободное программное обеспечение.

## OpenVPN версии 1

OpenVPN вышла на сцену решений VPN 13 мая 2001 года с первоначальным релизом, который едва мог туннелировать IP-пакеты через UDP, и мог только шифровать с шифром Blowfish и подписями SHA HMAC (методы безопасного шифрования и подписи). Эта версия была уже пронумерована 0.90, что казалось амбициозным, так как только одна версия (0.91) последовала в 2001 году, предлагая расширенную поддержку шифрования. Для поддержки SSL/TLS пользователям пришлось ждать почти год после первого выпуска. Версия 1.0 была выпущена в марте 2002 года и обеспечивала аутентификацию на основе SSL/TLS и обмен ключами. Эта версия также была первой, которая содержала документацию в виде manpage.

Затем развитие OpenVPN набрало обороты. Уже через пять дней была выпущена версия 1.0.2, которая была первой версией с дополнительными адаптациями для систем, основанных на RPM. Начиная с этой версии, релизы публиковались почти регулярно каждые четыре-восемь недель.

В следующей таблице приведен обзор выпусков и перечислены даты и версии, когда некоторые выбранные функции были добавлены в 1.x версию OpenVPN. Более подробную информацию можно найти в разделах **Change Log** на веб-сайте OpenVPN по адресу http://openvpn.net/changelog.html и примечания к выпуску на http://openvpn.net/relnotes.html.

| Дата            | Версия | Важные особенности/изменения |
| :-------------- | :----- | :--------------------------- |
| 13 мая 2001     | 0.90   | Первоначальный выпуск, с несколькими функциями, такими как IP через UDP и только одним механизмом шифрования. |
| 26 декабря 2001 | 0.91   | Добавлены дополнительные механизмы шифрования. |
| 23 марта 2001   | 1.0    | Добавлена аутентификация на основе TLS и обмен ключами. Была включена первая страница руководства. |
| 28 марта 2011   | 1.0.2  | Были сделаны исправления ошибок и улучшения, особенно для RPM-систем, таких как Red Hat. |
| 9 апреля 2002   | 1.1.0  | Расширенная поддержка TLS/SSL. Было добавлено формирование (шейпинг) трафика. Был включен первый порт OpenBSD. Расширенная защита от повторов сделала OpenVPN более безопасным. Дальнейшее улучшение документации (manpage)  |
| 22 апреля 2002  | 1.1.1  | Опции для автоматической конфигурации сети OpenVPN. Были введены функции контроля неактивности.  |
| 22 мая 2002     | 1.2.0  | Была добавлена поддержка файла конфигурации. SSL/TLS как фоновый процесс - теперь возможны более длинные ключи. Были добавлены/улучшены различные порты (Solaris, OpenBSD, Mac OSX, x64). Веб-сайт был улучшен, был включен раздел 'Howto'. Установка без automake теперь была возможна.  |
| 12 июня 2002    | 1.2.1  | Были предоставлены бинарные RPM-файлы для установки в системах на базе Red Hat. Основные улучшения в обработке сигналов и управлении ключами при перезапуске. Поддержка динамических изменений во входящих пакетах (таких как динамические IP-адреса). Добавлена поддержка понижения идентичности после установки - OpenVPN можно запускать как непривилегированный пользователь. |
| 10 июля 2002    | 1.3.0  |   |
| 10 июля 2002    | 1.3.1  | «Домашние выпуски» - исправления ошибок, незначительные улучшения и новые функции. Работает теперь с OpenSSL 0.9.7 Beta 2. |
| 23 октября 2002 | 1.3.2  | Добавлен порт NetBSD. Поддержка инстанцирования inetd/xinetd под Linux. Добавлено простое создание SSL/TLS сертификатов (easy-rsa скрипт). Добавлена поддержка IPv6 через TUN. |
| 7 мая 2003      | 1.4.0  | Улучшение защиты повторов (безопасность). Многочисленные исправления ошибок, улучшения и дополнения. |
| 15 мая 2003     | 1.4.1  | Улучшена поддержка ядра 2.4.  |
| 15 июля 2003    | 1.4.2  | Первые начинания порта Windows (но все еще отсутствуюет драйвер ядра Windows). Сценарий Gentoo init.  |
| 4 августа 2003  | 1.4.3  | Релиз исправления ошибок |
| 20 ноября 2003  | 1.5.0 (и 14 бета версия до этого) | Списки аннулирования сертификатов. Поддержка TCP. Был добавлен порт для Windows 2000 и XP, также включен установщик Win32. Повышенная проверка параметров конфигурации. Добавлена поддержка прокси. Расширенные функции маршрутизации (например, шлюз перенаправления). Улучшена поддержка TLS, расширены функции ключей и шифров. |
| 9 мая 2004      | 1.6.0 (включая 4 релиз-кандидата и 7 бета-версий) | Добавлена поддержка прокси-сервера SOCKS. Различные улучшения сетевого поведения Windows - протокола динамической конфгурации хоста (DHCP). Были проведены различные фиксы ошибок. |

## OpenVPN версии 2

Параллельно с усовершенствованием и развитием OpenVPN версии 1, в ноябре 2003 года был создан испытательный стенд для OpenVPN версии 2. В феврале 2004 года версия 2.0-test3 первоначально подготовила цель для мульти-клиентского сервера для OpenVPN. Этот мульти-клиентский сервер является одной из самых выдающихся особенностей OpenVPN на сегодняшний день. Несколько клиентов могут подключаться к VPN-серверу на одном и том же порту. 22 февраля 2004 года две ветви разработки, 1.6-beta7 и 2.0-test3, были объединены, и дальнейшее развитие было продолжено в ветви версии 2.

Было менее 29 версий, помеченных как "тестовые", 20 бета-версий и 21 релиз-кандидат, пока 17 апреля 2005 года не была выпущена OpenVPN версии 2.0. Это было возможно только благодаря большому количеству разработчиков, которые вносили свой вклад в проект, исправляя ошибки и постоянно улучшая производительность и стабильность.

Следующий список даст краткий обзор новых функций, которые были добавлены в OpenVPN версии 2:

* **Поддержка нескольких клиентов**: OpenVPN предлагает специальный режим подключения, в котором клиенты с проверкой подлинности TLS (которые не занесены в черный список CRL) предоставляются в стиле DHCP с IP-адресами и сетевыми данными (туннелями). Таким образом, несколько туннелей (до 128) могут взаимодействовать через один и тот же порт TCP или UDP. Очевидно, что для активации режима сервера стал необходим переключатель управления режимом.
* **Параметры Push/pull**: сетевая настройка клиентов может управляться сервером. После успешной установки туннеля сервер может сказать клиенту (как Windows так и Linux), чтобы он немедленно использовал другую сетевую установку.
* Добавлен интерфейс управления (Telnet).
* Драйвер и программное обеспечение Windows были значительно улучшены.

Текущая стабильная версия OpenVPN - это версия 2.0.9, выпущенная 1 октября 2006 года. В списках рассылки есть много сообщений о том, что кандидаты на выпуск версии 2.1 очень стабильны и могут использоваться также в корпоративных средах. Используйте их на свой страх и риск.

## Дорога к версии 2.1

С середины 2005 года разработчики OpenVPN непрерывно работают над новейшей версией OpenVPN, то есть 2.1. На момент написания статьи (конец 2008 года) Пятнадцатый релиз-кандидат был самой последней версией OpenVPN. В следующей таблице показаны улучшения, которые программисты добавили в пути:

| Дата            | Версия | Важные особенности/изменения |
| :-------------- | :----- | :--------------------------- |
| 12 июня 2005    | 2.0.1-RC3 | Клиентской стороне добавлена поддержка push и pull скриптов протокола DHCP-опции 'DOMAIN' и 'DNS' |
| 15 июня 2005    | 2.0.1-rc4 | Поддержка LZO2 |
| 21 июля 2005    | 2.0.1-rc6 | символ "@" теперь можно использовать в именах файлов клиентских конфигах/каталогах |
| 21 июля 2005    | 2.0.1-rc7 | Поддержка LZO2.1 |
| 15 августа 2005 | 2.0.1     | Различные средства защиты (DOS-атаки против очередей ошибок и др.), опция `auth-retry` добавлена в интерфейс управления |
| 25 августа 2005 | 2.0.2     | Исходный код удаляется из установщика Windows, исправления ошибок и безопасности (без изменений с 2.0.2-rc1) |
| 7 сентября 2005 | 2.0.2-TO1 | Новые возможности: `--topology`, `--redirect-gateway bypass-dhcp` для нелокальных DHCP-серверов, служба DHCP-клиента становится зависимой от Windows, интерфейс плагина расширен. |
| 23 сентября 2005 | 2.0.2-TO4 | Windows-TAP-Adapter можно открыть в режиме без администратора, `--redirect-gateway bypass-dns`, когда добавлена опция нелокальных DNS-серверов. |
| 1 октября 2005  | 2.1.beta1 | Директива сжатия (LZO) может быть передана клиентам, слияние версий с 2.0.3-rc1, переименование нескольких каталогов (easy-rsa). |
| 16 октября 2005 | 2.1.beta3 | Поддержка формата ключа PKCS#11, несколько патчей для обработки сертификата. добавлена опция --bind. |
| 12 Ноября 2005  | 2.1.beta7 | Сертификаты и ключи теперь могут быть определены внутри файла конфигурации. Многострочные списки параметров для плагинов. Много фиксов и заплат. |
| 3 января 2006   | 2.1.beta8 | `--topology` подсети также для Macintosh систем, автоматическое обнаружение прокси-сервера (только для Windows), улучшение сетевой обработки для Windows (обе `--ip-win32` и `--route` теперь имеют адаптивный стандарт, в Windows OpenVPN сначала пытается использовать API-помощник IP , затем возвращается к команде маршрута. |
| 16 февраля 2006 |2.1.beta9 | Совместное использование портов позволяет одновременно использовать HTTPS-сервер и OpenVPN на одном и том же порту. Добавляет опцию клиента управления и байтовый счет к интерфейсу управления. |
|   | 2.1.beta10-16 | Многочисленные фиксов и патчи, режим топологии также для BSD, опция `--route-metric`, теперь можно указывать Mac-адрес для виртуальных интерфейсов. Обновления установщика Windows, Easy-RSA-обновление, обновлена ​​обработка PKCS#11. |
| 31 октября 2006  |2.1_rc1  | Первый релиз-кандидат версии 2.1, только незначительные изменения. |
| С 27 февраля 2007 по 25 апреля 2007 | 2.1_rc2-4 | Первые обходные пути для распространенных 64-битных проблем Vista и Windows, несколько фиксов и патчей. Подписи для установщика, OpenVPN GUI как вариант установки в Windows. |
| 23 января 2008 | 2.1_rc5 | Улучшенная система сборки Windows, включая пользовательский установщик и OpenSSL 0.9.7m. Непривилегированный режим для Linux. |
| 11 июня 2008   | 2.1_rc8 | Возможность клиентского пакетирования и аутентификации в интерфейсе управления. Профили подключения на стороне клиента. Версия для Windows содержит OpenSSL 0.9.8h. Поддержка проверки подлинности прокси NTLMv2. Многочисленные исправления, патчи и небольшие расширения функций. |
| 10 сентября 2008 | 2.1_rc10 | Новый режим сервер-мост, который работает как DHCP-прокси, опция `--route-gateway dhcp` позволяет использовать прежний шлюз по умолчанию, предоставляемый DHCP. OpenVPN предупреждает о конфликтах адресов, а директива `--allow-pull-fqdn` позволяет использовать DNS-имена вместо IP-адресов для нескольких сетевых опций. Многочисленные фиксы и патчи, обширное усиление безопасности. Сценарии существуют, потому что rc8 обрабатывался execve и CreateProcess вместо вызовов `system()`. Rc10 обеспечивает обратную совместимость. |
| 7 октября 2008 | 2.1.rc13 | Openssl 0.9.8i для пакета Windows, доменные сокеты для интерфейса управления, изменение авторских прав на OpenVPN Technologies, Inc. |
| 30 мая 2009    | 2.1.rc14-18 | Несколько исправлений ошибок, особенно для клиентов Windows. |

В дополнение к стабильной версии 2.1 разрабатывается коммерческая версия 3.0. Возможно, вы заметили, что с начала октября 2008 года авторские права OpenVPN изменились на OpenVPN Technologies, INC., компания, основанная Джеймсом Йонаном. Эта компания разрабатывает несколько продуктов на основе OpenVPN для бизнес-установок. Скоро будет доступна версия с коммерческой поддержкой и аппаратным устройством, услугами и поддержкой, а также веб-интерфейсом управления. С 2008 года редизайн сайта OpenVPN отражает профессиональный подход к бизнес-клиентам.

## Сетевое взаимодействие с OpenVPN

Модульную структуру OpenVPN можно найти не только в его модели безопасности, но и в сетевой схеме. Джеймс Йонан выбрал универсальный драйвер TUN/TAP для сетевого уровня OpenVPN.

Драйвер TUN/TAP - это проект с открытым исходным кодом, который входит во все современные дистрибутивы Linux/Unix, а также Windows, Solaris и Mac OS X. Как и SSL/TLS, он используется во многих проектах и поэтому постоянно совершенствуется и добавляются новые функции. Использование устройств TUN/TAP убирает множество сложностей со структуры OpenVPN. Его простая структура обеспечивает повышенную безопасность по сравнению с другими решениями VPN. Сложность всегда является главным врагом безопасности. Например, IPsec имеет сложную структуру со сложными модификациями в ядре и стеке IP, что создает множество возможных лазеек безопасности.

Универсальный драйвер TUN/TAP был разработан для обеспечения поддержки ядром Linux туннелирования IP-трафика. Это виртуальный сетевой интерфейс, который является аутентичным для всех приложений и пользователей. Только название tunX или tapX отличает его от других устройств. Каждое приложение, способное использовать сетевой интерфейс, может использовать туннельный интерфейс. Каждая технология, запущенная в вашей сети, также может быть запущена на интерфейсе TUN или TAP.

Этот драйвер является одним из основных факторов, который делает OpenVPN очень простым для понимания, простым в настройке и в то же время очень безопасным.

На следующем рисунке показан OpenVPN, использующий стандартные интерфейсы:

![](/pics/pic3-1.png)

Устройство TUN можно использовать как виртуальный интерфейс точка-точка, например модем или DSL-канал. Этот режим называется **маршрутизируемым**, так как маршруты настраиваются на VPN-партнера.

Однако устройство TAP можно использовать как виртуальный адаптер Ethernet. Это позволяет демону, прослушивающему интерфейс, захватывать кадры Ethernet, что невозможно с устройствами TUN. Этот режим называется **мостовым**, так как сети соединяются как бы по аппаратному мосту. Приложения могут читать/записывать в этот интерфейс. Программное обеспечение (драйвер туннеля) будет принимать все данные и использовать криптографические библиотеки SSL/TLS для их шифрования. Данные упаковываются и отправляются на другой конец туннеля. Эта упаковка выполняется с помощью стандартизированных UDP или дополнительных TCP-пакетов. UDP должен быть первым выбором, но TCP может быть полезен в некоторых случаях. Вы почти полностью свободны в выборе параметров конфигурации, таких как номера протоколов или портов, при условии, что оба конца туннеля согласуются с одинаковыми цифрами.

---

OpenVPN прослушивает устройства TUN/TAP, принимает трафик, шифрует его и отправляет другому партнеру VPN, где другой процесс OpenVPN получает данные, расшифровывает их и передает виртуальному сетевому устройству, где приложение уже может ожидать данные.

---

Насколько мне известно, существует лишь несколько других программных приложений VPN, которые позволяют партнерам VPN передавать данные. Эта концепция предлагает следующие захватывающие возможности:

* Трансляции необходимы для просмотра сетей Windows или для игр в локальной сети
* Не IP-пакеты, такие как IPX, могут использоваться, и в вашей локальной сети возможно почти все, что передается через VPN на другую сторону

Поскольку OpenVPN использует стандартные сетевые пакеты, NAT также не является проблемой. Хост в локальной сети в Сиднее с локальным IP может начать туннель к другому хосту в локальной сети в Лондоне, если он также оснащен локальным IP.
Но это еще не все. Поскольку сетевой интерфейс является стандартизированным сетевым интерфейсом Linux (TUN или TAP), все возможное на сетевой карте Ethernet также может быть сделано на VPN-туннелях. Рассмотрим следующее:

* Брандмауэры могут ограничивать и контролировать трафик
* Формирование трафика не только возможно, но это также функция, включенная в OpenVPN

Кроме того, если вы хотите использовать DSL-линии с частыми переподключениями и динамически назначаемыми IP-адресами, OpenVPN будет вашим первым выбором. Переподключение происходит намного быстрее, чем у любого другого программного обеспечения VPN, которое мы протестировали. Сеанс сервера терминалов Windows или SSH не завершается, когда один из партнеров VPN изменяет свой IP. Сеанс просто замирает на несколько секунд, а затем вы можете продолжить. Может ли ваш VPN достичь этого?
