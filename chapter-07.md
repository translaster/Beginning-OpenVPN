# Конфигурирование OpenVPN-сервера

В этой главе мы создадим ключ шифрования для OpenVPN и используем их для настройки нашего первого туннеля OpenVPN между двумя системами Windows в одной сети. Таким образом, у нас есть тестовая среда, где никакие проблемы с брандмауэрами или маршрутизаторами не будут мешать нашей настройке OpenVPN, и мы можем сосредоточиться на изучении того, как создавать туннели.

Необходимо немного поработать над конфигурационным файлом и обменяться ключами между этими системами. После этого туннель будет запущен и протестирован с помощью команды ping. Затем мы скопируем ключ в систему Linux и подключим эту систему с помощью туннеля к первой машине Windows. Наконец, мы обеспечим автоматический запуск OpenVPN на обеих системах и посмотрим на Диспетчер служб в Windows и систему `init` в Linux.

## OpenVPN в Microsoft Windows

В процессе установки OpenVPN создает следующие записи в главном меню Windows, как показано на Windows XP:

![](/pics/pic7-1.png)

В Windows Server 2008 с OpenVPN 2.1_rc15 создаются следующие записи:

![](/pics/pic7-2.png)

Как вы можете видеть, в зависимости от вашей версии Windows и OpenVPN, точное расположение в меню может варьироваться.

На данный момент актуальны только следующие пять пунктов этого меню:

| Название                           | Функция  |
| :--------------------------------- | :------- |
| Generate a static OpenVPN key      | Создание статического ключа шифрования, который можно использовать для создания туннелей |
| OpenVPN confguration fle directory | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\config`, в которых хранятся конфгурационные данные для OpenVPN |
| OpenVPN GUI                        | Запускает **OpenVPN GUI**, который подключается в системном трее панели задач |
| OpenVPN log fle directory          | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\log`, где хранятся файлы журнала для OpenVPN |
| OpenVPN Sample Confguration Files  | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\sample-config`, где можно найти пример файлов конфигурации для OpenVPN |

Помимо этих записей, вы найдете информацию об OpenVPN на странице онлайн-руководства, файл readme, ссылку на веб-сайт и некоторые записи, помогающие управлять сетевыми интерфейсами, которые создает OpenVPN. В OpenVPN 2.1 запись для быстрого генерирования ключей можно найти в разделе `Utilities`.

### Генерация статического ключа OpenVPN

Прежде чем мы сможем соединить две системы с туннелем OpenVPN, мы должны создать статический ключ, который будет использоваться для шифрования трафика. Этот ключ должен быть предоставлен обеим системам, поскольку в этом случае симметричного шифрования обе стороны будут использовать один и тот же ключ.

Выберите пункт **Generate a static OpenVPN key** в меню **OpenVPN** Windows:

![](/pics/pic7-3.png)

OpenVPN откроет окно командной строки и сгенерирует 2048-битный ключ шифрования. Этот ключ сохраняется в каталоге стандартной конфигурации с именем `key.txt`. Этот ключ следует использовать только для тестирования и обучения. Однако для нашей небольшой тестовой установки это необходимо.

Этот процесс также выполняется с помощью программы `openvpn.exe`. Ярлык вызывает следующее:

```
"C:\Program Files\OpenVPN\bin\openvpn.exe" --pause-exit --verb 3
--genkey --secret "C:\Program Files\OpenVPN\config\key.txt"
```

---

Не используйте этот ключ ни для чего, кроме тестирования соединений OpenVPN.

---

В следующей главе мы объясним использование интерфейса командной строки OpenVPN.

Пункт меню **OpenVPN GUI** запускает апплет панели OpenVPN. Если такой записи нет в вашей системе, то вы можете найти программу в `C:\Program files\ OpenVPN\bin\openvpn-gui.exe`. После установки этот апплет работает в фоновом режиме, поэтому щелчок по этому пункту меню вызовет только окно с сообщением, что графический интерфейс OpenVPN уже запущен. Если вы остановите графический интерфейс, то эта запись перезапустит апплет панели.

Остальные три пункта меню открывают окна Проводника в трех разных каталогах:
* Каталог `C:\Program Files\OpenVPN\config\` - это место по умолчанию, где OpenVPN будет искать конфигурационные и файлы ключей. Посмотрите на скриншот генерации ключа, и вы увидите что ключ, который мы создали, записан в `C:\Program files\OpenVPN\config\key.txt`.
* В каталоге `C:\Program files\ OpenVPN\sample-config\`, мы найдем конфигурационные файлы для стандартной установки. Эти файлы должны быть слегка изменены и затем могут быть использованы для тестирования функциональности VPN.
* Вывод программного обеспечения туннеля записывается в текстовые файлы в каталоге `C:\Program files\OpenVPN\log\`.

На следующем снимке экрана показано расположение окон Проводника четырех наиболее важных каталогов OpenVPN:

![](/pics/pic7-4.png)

#### Создание примера подключения

Теперь мы создадим пример VPN-соединения, чтобы увидеть, как работает графический интерфейс OpenVPN. Откройте все три каталога, нажав на их записи в главном меню. Скопировать образец конфигурационного файла `sample.ovpn` из каталога примера конфигурации в каталог конфигурации. В Windows стандартным расширением файла конфигурации OpenVPN является `.ovpn`, тогда как на Linux это `.conf`.

Для этого можно использовать функцию перетаскивания. Вот и все! Ваша новая конфигурация OpenVPN может быть запущена через апплет панели - если ваша сеть соответствует требованиям образца конфигурации.

Щелкните правой кнопкой мыши на панели апплета. Вы увидите, что контекстное меню теперь содержит больше записей. Выберите пункт `Edit Config`, чтобы просмотреть пример файла в `notepad.exe`, и нажмите кнопку **Connect** чтобы запустить пример конфигурации.

![](/pics/pic7-5.png)

Откроется окно **OpenVPN Connection (sample)**. В этом окне отображается вывод протокола примерного соединения, который также записывается в файл журнала в каталоге журнала. Вы можете видеть, что все еще есть некоторая работа над конфигурацией, которую нужно сделать. В примере конфигурации OpenVPN - это рекомендуется подключиться к удаленному серверу под названием **myremote**. Если у вас нет сервера OpenVPN с таким именем в вашей локальной сети, то вы должны увидеть окно, точно такое же, как и следующее. Это означает, что ваше программное обеспечение Windows OpenVPN работает, но не может создать туннель.

![](/pics/pic7-6.png)

#### Адаптация примера конфигурационного файла, предоставленного OpenVPN

Очевидно, нам придется немного изменить нашу конфигурацию. В главном меню Windows выберите пункт **OpenVPN configuration file directory** и дважды щелкните по образцу файла конфигурации, который мы скопировали здесь. Запустится Блокнот и покажет нам пример файла конфигурации.

![](/pics/pic7-7.png)
