# Конфигурирование OpenVPN-сервера

В этой главе мы создадим ключ шифрования для OpenVPN и используем их для настройки нашего первого туннеля OpenVPN между двумя системами Windows в одной сети. Таким образом, у нас есть тестовая среда, где никакие проблемы с брандмауэрами или маршрутизаторами не будут мешать нашей настройке OpenVPN, и мы можем сосредоточиться на изучении того, как создавать туннели.

Необходимо немного поработать над конфигурационным файлом и обменяться ключами между этими системами. После этого туннель будет запущен и протестирован с помощью команды ping. Затем мы скопируем ключ в систему Linux и подключим эту систему с помощью туннеля к первой машине Windows. Наконец, мы обеспечим автоматический запуск OpenVPN на обеих системах и посмотрим на Диспетчер служб в Windows и систему `init` в Linux.

## OpenVPN в Microsoft Windows

В процессе установки OpenVPN создает следующие записи в главном меню Windows, как показано на Windows XP:

![](/pics/pic7-1.png)

В Windows Server 2008 с OpenVPN 2.1_rc15 создаются следующие записи:

![](/pics/pic7-2.png)

Как вы можете видеть, в зависимости от вашей версии Windows и OpenVPN, точное расположение в меню может варьироваться.

На данный момент актуальны только следующие пять пунктов этого меню:

| Название                           | Функция  |
| :--------------------------------- | :------- |
| Generate a static OpenVPN key      | Создание статического ключа шифрования, который можно использовать для создания туннелей |
| OpenVPN confguration fle directory | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\config`, в которых хранятся конфгурационные данные для OpenVPN |
| OpenVPN GUI                        | Запускает **OpenVPN GUI**, который подключается в системном трее панели задач |
| OpenVPN log fle directory          | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\log`, где хранятся файлы журнала для OpenVPN |
| OpenVPN Sample Confguration Files  | Открывает окно Проводника в каталоге `C:\Program файлы\OpenVPN\sample-config`, где можно найти пример файлов конфигурации для OpenVPN |

Помимо этих записей, вы найдете информацию об OpenVPN на странице онлайн-руководства, файл readme, ссылку на веб-сайт и некоторые записи, помогающие управлять сетевыми интерфейсами, которые создает OpenVPN. В OpenVPN 2.1 запись для быстрого генерирования ключей можно найти в разделе `Utilities`.

### Генерация статического ключа OpenVPN

Прежде чем мы сможем соединить две системы с туннелем OpenVPN, мы должны создать статический ключ, который будет использоваться для шифрования трафика. Этот ключ должен быть предоставлен обеим системам, поскольку в этом случае симметричного шифрования обе стороны будут использовать один и тот же ключ.

Выберите пункт **Generate a static OpenVPN key** в меню **OpenVPN** Windows:

![](/pics/pic7-3.png)

OpenVPN откроет окно командной строки и сгенерирует 2048-битный ключ шифрования. Этот ключ сохраняется в каталоге стандартной конфигурации с именем `key.txt`. Этот ключ следует использовать только для тестирования и обучения. Однако для нашей небольшой тестовой установки это необходимо.

Этот процесс также выполняется с помощью программы `openvpn.exe`. Ярлык вызывает следующее:

```
"C:\Program Files\OpenVPN\bin\openvpn.exe" --pause-exit --verb 3
--genkey --secret "C:\Program Files\OpenVPN\config\key.txt"
```

---

Не используйте этот ключ ни для чего, кроме тестирования соединений OpenVPN.

---

В следующей главе мы объясним использование интерфейса командной строки OpenVPN.

Пункт меню **OpenVPN GUI** запускает апплет панели OpenVPN. Если такой записи нет в вашей системе, то вы можете найти программу в `C:\Program files\ OpenVPN\bin\openvpn-gui.exe`. После установки этот апплет работает в фоновом режиме, поэтому щелчок по этому пункту меню вызовет только окно с сообщением, что графический интерфейс OpenVPN уже запущен. Если вы остановите графический интерфейс, то эта запись перезапустит апплет панели.

Остальные три пункта меню открывают окна Проводника в трех разных каталогах:
* Каталог `C:\Program Files\OpenVPN\config\` - это место по умолчанию, где OpenVPN будет искать конфигурационные и файлы ключей. Посмотрите на скриншот генерации ключа, и вы увидите что ключ, который мы создали, записан в `C:\Program files\OpenVPN\config\key.txt`.
* В каталоге `C:\Program files\ OpenVPN\sample-config\`, мы найдем конфигурационные файлы для стандартной установки. Эти файлы должны быть слегка изменены и затем могут быть использованы для тестирования функциональности VPN.
* Вывод программного обеспечения туннеля записывается в текстовые файлы в каталоге `C:\Program files\OpenVPN\log\`.

На следующем снимке экрана показано расположение окон Проводника четырех наиболее важных каталогов OpenVPN:

![](/pics/pic7-4.png)

#### Создание примера подключения

Теперь мы создадим пример VPN-соединения, чтобы увидеть, как работает графический интерфейс OpenVPN. Откройте все три каталога, нажав на их записи в главном меню. Скопировать образец конфигурационного файла `sample.ovpn` из каталога примера конфигурации в каталог конфигурации. В Windows стандартным расширением файла конфигурации OpenVPN является `.ovpn`, тогда как на Linux это `.conf`.

Для этого можно использовать функцию перетаскивания. Вот и все! Ваша новая конфигурация OpenVPN может быть запущена через апплет панели - если ваша сеть соответствует требованиям образца конфигурации.

Щелкните правой кнопкой мыши на панели апплета. Вы увидите, что контекстное меню теперь содержит больше записей. Выберите пункт `Edit Config`, чтобы просмотреть пример файла в `notepad.exe`, и нажмите кнопку **Connect** чтобы запустить пример конфигурации.

![](/pics/pic7-5.png)

Откроется окно **OpenVPN Connection (sample)**. В этом окне отображается вывод протокола примерного соединения, который также записывается в файл журнала в каталоге журнала. Вы можете видеть, что все еще есть некоторая работа над конфигурацией, которую нужно сделать. В примере конфигурации OpenVPN - это рекомендуется подключиться к удаленному серверу под названием **myremote**. Если у вас нет сервера OpenVPN с таким именем в вашей локальной сети, то вы должны увидеть окно, точно такое же, как и следующее. Это означает, что ваше программное обеспечение Windows OpenVPN работает, но не может создать туннель.

![](/pics/pic7-6.png)

#### Адаптация примера конфигурационного файла, предоставленного OpenVPN

Очевидно, нам придется немного изменить нашу конфигурацию. В главном меню Windows выберите пункт **OpenVPN configuration file directory** и дважды щелкните по образцу файла конфигурации, который мы скопировали здесь. Запустится Блокнот и покажет нам пример файла конфигурации.

![](/pics/pic7-7.png)

В этом файле мы должны изменить или ввести следующие три параметра:
* Имя или IP-адрес другого хоста VPN
* Имя файла ключа
* IP-адреса для VPN и хоста

OpenVPN нужен IP-адрес другой конечной точки туннеля, чтобы знать, к чему подключиться. Чтобы убедиться что обе стороны используют один и тот же ключ шифрования, мы должны указать файл, в котором хранится ключ. И последнее, но не менее важное: сама туннельная сеть должна быть снабжена IP-адресами. Эти IP-адреса назначаются виртуальному сетевому адаптеру. Каждый туннель имеет по одному виртуальному сетевому адаптеру на каждой стороне и обе стороны могут взаимодействовать друг с другом только в том случае, если они находятся в одном сегменте сети. Таким образом, мы должны выбрать IP-адрес для каждого хоста. В моем примере я использую IP-адреса, предоставленные набором файлов примера, а именно 10.3.0.1 и 10.3.0.2.

После того, как вы выбрали соответствующие параметры для этих настроек, вы можете легко подключить две системы. Просто имейте в виду, что вам нужно иметь настройки для зеркального отображения IP-адресов.

В следующей таблице показаны мои записи файла конфигурации OpenVPN для двух хостов, подключенных через OpenVPN, которые находятся в одной подсети, а именно 10.10.10.0:

| Host A (10.10.10.103) | Host B (10.10.10.104) |
| :-------------------- | :-------------------- |
| remote 10.10.10.104   | remote 10.10.10.103   |
| ifconfg 10.3.0.1 255.255.255.0 | ifconfg 10.3.0.2 255.255.255.0 |
| secret key.txt        | secret key.txt        |

Это единственные параметры конфигурации в файлах конфигурации OpenVPN, которые важны при настройке нашего примера туннеля:
* `remote`: определяет другой конец туннеля. Здесь можно использовать IP-адреса или записи DNS.
* `ifconfig`: задает локальный IP и сетевую маску для туннельного интерфейса. **secret** указывает OpenVPN, какой файл ключа использовать относительно каталога конфигурации.

Следующий график должен помочь немного прояснить это:

![](/pics/pic7-8.png)

Для туннеля OpenVPN задействованы четыре сетевых устройства. Два из них являются реальными картами Ethernet, а два других - виртуальными туннельными устройствами (TUN или TAP). Реальные сетевые устройства имеют назначенные им IP-адреса, по которым система доступна в своей локальной сети. Устройства виртуальной сети имеют назначенные им IP-адреса, которые используются для настройки туннеля.

В нашем маленьком примере, Host A с локальным адресом **10.10.10.103** пытается подключиться к Host B с адресом **10.10.10.104**. IP-адрес виртуального сетевого интерфейса (в туннельной сети) для узла A равен **10.3.0.1**, а для узла B - **10.3.0.2**. Имя файла ключа - `key.txt` в обеих системах.

---

OpenVPN может принимать либо IP-адреса, либо DNS в качестве вариантов для параметра `remote`. Если вы используете DNS-имена, то должны убедиться, что разрешение доменных имен в вашей системе настроено правильно. В любом случае, вы должны убедиться, что другой хост доступен — проверьте DNS, маршрутизацию и конфгурацию firewall.

---

Возможно, вы заметили, что два узла в нашем примере находятся в одной подсети. Это простая настройка, где не будет проблем маршрутизации, DNS или брандмауэр не будут мешать нашим туннелям. Все, что нам нужно, это два компьютера под управлением OpenVPN. Опция `remote` - это единственная опция, которую нужно изменить позже, когда мы настроим туннель между двумя интернет-местоположениями. OpenVPN позволяет использовать здесь как DNS-имена, так и IP-адреса.

Теперь скопируйте ключ файла `ключа.txt` во второй системе и отредактируйте файл конфигурации этой системы. Простой способ сделать это - создать общую папку в одной системе и подключить ее как сетевой диск в другой системе.

#### Запуск и тестирование туннеля

Когда обе системы будут готовы, запустите **OpenVPN GUI** (или убедитесь, что он запущен) и выберите пункт **Connect** из контекстного меню на обеих системах.

Если все сработало нормально, значок OpenVPN на обеих системах изменится на зеленый, как здесь:

![](/pics/pic7-9.png)

Если вы видите красный свет, то туннель OpenVPN не подключен. Во время настройки соединения отображается желтый цвет. После успешного завершения этого процесса значок переключается на зеленый.

Однако если вы используете локальный брандмауэр в любой системе, убедитесь, что он не блокирует эти пакеты. Брандмауэр Windows XP, как и большинство систем брандмауэра, по умолчанию не блокирует исходящие пакеты, что означает - соединение OpenVPN всегда должно быть установлено. Если вы столкнулись с проблемами подключения, то проверьте раздел _Устранение неполадок брандмауэра_ в конце этой главы.

Выберите пункт **Show Status** из контекстного меню **OpenVPN GUI**, чтобы получить более подробную информацию о процессе подключения, как показано на следующем скриншоте:

![](/pics/pic7-10.png)

На данный момент важна только последняя строка этого вывода: **Initialization Sequence Completed** - это сообщение OpenVPN об успехе. Ваш туннель запущен и работает и обе системы должны показать это сообщение в журнале состояния.

Теперь давайте протестируем туннель с помощью команды `ping`. Запустите оболочку DOS, выбрав пункт главного меню Windows **Run** и введя команду **cmd.exe**. Вам будет представлен интерфейс командной строки, как показано на следующем снимке экрана. Введите `ping 10.3.0.2` на узле A, чтобы проверить правильность передачи пакетов ping на узел B. На узле B вам нужно будет ввести `ping 10.3.0.1` если вы использовали те же сетевые адреса, что и в предыдущем примере.

Если вы получаете вывод, как на следующем снимке экрана, то команда `ping` была успешной и туннель OpenVPN работает.

![](/pics/pic7-11.png)

### Краткий обзор сетевых интерфейсов Windows OpenVPN

В системе Windows откройте **Панель управления** и выберите пункт **Сетевые подключения**. Как вы можете видеть, для каждого туннеля OpenVPN, который вы настраиваете, добавляется виртуальный сетевой интерфейс. На следующем снимке экрана показан активный интерфейс по-умолчанию когда туннель включен. Он похож на реальный сетевой интерфейс и может использоваться как любой другой интерфейс. Чтобы убедиться в этом - загляните в диалоговое окно свойств в контекстном меню значка интерфейса. Помимо того, что этот интерфейс представлен в виде **TAP-Win32 Adapter V8**, здесь также можно выбрать все возможные настройки для реальных сетевых адаптеров. Вот как это выглядит на Windows XP:

![](/pics/pic7-12.png)

На более новых системах TAP-адаптер будет версии 9 (`V9`). Вы можете отключить этот интерфейс, просто дважды щелкнув по его значку. Но имейте в виду, что туннель не будет подключен автоматически, когда вы снова включите интерфейс. Вы должны повторно подключиться вручную, выбрав пункт в контекстном меню OpenVPN.

Если вам нужна подробная информация о сетевых интерфейсах, команда `ipconfig/all` будет очень полезна. Откройте оболочку DOS под Windows и введите `ipconfig/all`. Windows выведет список всех доступных сетевых интерфейсов, IP-адресов и данных маршрутизации.

![](/pics/pic7-13.png)

## Подключение Windows и Linux

Соединения между этими двумя операционными системами почти так же просты, как и описанные в предыдущем разделе. Шаги, которые необходимо предпринять, точно такие же. Однако есть две ловушки, которых вы должны избегать, и обе из них связаны с передачей файлов из Windows в Linux и наоборот.

### Обмен файлами между Windows и Linux

Системы Windows используют протокол **Server Message Block (SMB)** для передачи и обмена данными. Linux не имеет собственной поддержки SMB, но есть мощный серверный пакет под названием **Samba**, который можно использовать, чтобы сделать машины Linux похожими на ПК с Windows (и даже интегрировать их в домены Active Directory). С небольшим ноу-хау Linux и правильными инструментами, доступ к такому диску samba прост. Просто установите клиент Linux samba и направьте инструмент, такой как KDE konqueror, на вашу машину Windows, как показано на следующем снимке экрана:

![](/pics/pic7-14.png)

В системах SuSE, например, требуются только два пакета, а именно `kdebase3-samba` и `libsbclient`. После установки их с помощью `zypper install kdebase3-samba libsmbclient`, вы можете ввести URL-адрес, как `smb://User@Windowshost:/Путь/к/файлам` в Konqueror и легко открыть и перетащить соответствующие файлы, после того, как вы разрешили удаленный доступ к соответствующей папке в операционной системе Windows.

#### WinSCP

Но как скопировать файл ключа с компьютера Windows на сервер Linux? В Linux удаленное выполнение команд и обмен данными через защищенную оболочку SSH является стандартом. SSH также использует OpenSSL для шифрования таким же образом, как OpenVPN. Однако Windows не имеет встроенной поддержки для такого зашифрованного обмена данными. У нас есть две возможности. Либо мы устанавливаем Samba на Linux в качестве клиента или сервера Windows, либо (это гораздо лучший выбор) устанавливаем клиентское программное обеспечение SSH на Windows. Очень простым инструментом для этой цели является **WinSCP**, который можно свободно скачать с сайта http://winscp.net/. WinSCP - это приложение в стиле проводника, которое обеспечивает копирование с помощью перетаскивания по защищенным соединениям.
* Загрузите WinSCP и дважды щелкните по файлу EXE.
* Выберите нужный язык и нажмите кнопку **ОК**.
* После приветствия вас попросят принять бесплатную лицензию GPL. Нажмите на кнопку **Next** дважды.
* Если вы хотите изменить местоположение этой программы, введите ее путь в третьем диалоговом окне.
* Выберите предпочтительный пользовательский интерфейс. Пожалуй, лучше всего для новичков подойдет стандартный **Norton Commander Interface**.

Это диалоговое окно позволяет выбрать внешний вид WinSCP по умолчанию. Если вы выберете **Norton Commander Interface**, то увидите окно файлового менеджера, разделенное на две части: локальную и удаленную директории. Это выбор по умолчанию и он может быть наиболее полезным. Однако если вы предпочитаете стиль Проводника Windows, то выберите кнопку **Explorer-like interface**, который представляет удаленный каталог в одном окне.

Завершите установку, нажав на кнопку **Next**, а затем **Install** в следующем диалоговом окне. Затем программа установки извлечет и настроит WinSCP. После - нажмите на кнопку **Finish**, WinSCP запустится автоматически.

#### Передача ключевого файла из Windows в Linux с помощью WinSCP

После запуска WinSCP вы должны указать ему к чему подключиться. Введите IP-адрес или DNS-имя вашей системы Linux в поле **Host Name**, имя пользователя Linux (администратор 'root') в поле **User Name** и пароль в поле **Password**. Другие варианты на данном этапе не нужны. Нажмите на кнопку **Login**, чтобы запустить соединение. Если вы подключаетесь в первый раз, WinSCP спросит вас, уверены ли вы в подлинности хоста, к которому хотите подключиться. Если вы нажмете здесь **OK**, то WinSCP запомнит подпись этого хоста в следующий раз.

![](/pics/pic7-15.png)

Если вы хотите сохранить свой профиль для последующего использования, нажмите кнопку **Save...**. Нажмите кнопку **Login**, чтобы запустить соединение, и примите окно **Warnimg** о неизвестном ключе хоста. На первый взгляд это нормально. Но если вы получите такое предупреждение позже, то вы должны проверить не сделали ли ошибку или почему ваш сервер имеет новый ключ. Был ли у взломщика шанс изменить его?

![](/pics/pic7-16.png)

WinSCP представляет окно, подобное следующему скриншоту. В левой части окна должен быть список локальных каталогов, в то время как в правой части отображается каталог на удаленном сервере. Небольшие выпадающие меню над списками позволяют быстро выбирать и изменять рабочие каталоги.

![](/pics/pic7-17.png)

Теперь давайте скопируем файл ключа и файл конфигурации из Windows в систему Linux. На компьютере с Windows перейдите в каталог `C:\Program Files\ OpenVPN\config`, в системе Linux, измените на `/etc/openvpn`. Перетащите и бросьте файл `key.txt` и файл конфигурации `sample.ovpn` для Linux-системы.

---

`.ovpn` - это стандартное расширение для конфигурационного файла Windows OpenVPN. `.conf` - это стандартное расширение OpenVPN для Linux.

---
